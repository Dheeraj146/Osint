{% extends "layout.html" %}

{% block content %}
<div class="page-header">
    <h2>üìç IP Intelligence</h2>
    <p>Analyze a public IP address with geolocation, port scanning, and threat intelligence data.</p>
</div>

<div class="content-container">
    <form method="post">
        <input type="text" name="ip_address" placeholder="Enter IP Address (e.g., 8.8.8.8)" size="30" required>
        <button type="submit">Lookup</button>
    </form>

    {% if results %}
    <div class="results-wrapper">

        <div class="button-container">
            <button class="copy-btn" data-target="results-container">Copy Results</button>
            <a href="{{ url_for('download_report', type='ip', query=ip_address) }}" class="button">Download Report</a>
        </div>

        <div id="results-container">

            {% if results.Error %}
                <h3 style="color: #ff4d4d;">Error</h3>
                <p>{{ results.Error }}</p>

            {% elif results.ipinfo.bogon %}
                <h3 style="color: #f39c12;">Private or Reserved IP</h3>
                <p>The IP address {{ results.ipinfo.ip }} is private/reserved and cannot be scanned.</p>

            {% else %}

                <h3>Results for {{ results.ipinfo.ip }}:</h3>

                <!-- IPinfo -->
                <div class="results-card">
                    <h4>Core Intelligence (IPinfo)</h4>
                    <ul>
                        <li><strong>Hostname:</strong> {{ results.hostname }}</li>
                        <li><strong>Location:</strong> {{ results.ipinfo.city }}, {{ results.ipinfo.region }}, {{ results.ipinfo.country }}</li>
                        <li><strong>Organization:</strong> {{ results.ipinfo.org }}</li>
                    </ul>
                </div>

                <!-- PYTHON PORT SCANNER -->
                <div class="results-card">
                    <h4>Open Ports (Fast Scan)</h4>
                    <ul>
                        {% if results.open_ports and results.open_ports|length > 0 %}
                            {% for port in results.open_ports %}
                                <li>Port {{ port }}: Open</li>
                            {% endfor %}
                        {% else %}
                            <li style="opacity: 0.6;">No open ports detected.</li>
                        {% endif %}
                    </ul>
                </div>

                <!-- AbuseIPDB -->
                <div class="results-card">
                    <h4>AbuseIPDB Reputation</h4>
                    {% if results.abuseipdb and (not results.abuseipdb.error) %}
                    <ul>
                        <li><strong>Confidence Score:</strong> {{ results.abuseipdb.abuseConfidenceScore }}%</li>
                        <li><strong>Total Reports:</strong> {{ results.abuseipdb.totalReports }}</li>
                        <li><strong>Usage Type:</strong> {{ results.abuseipdb.usageType }}</li>
                    </ul>
                    {% else %}
                    <p style="opacity: 0.6;">No data found.</p>
                    {% endif %}
                </div>

                <!-- VirusTotal -->
                <div class="results-card">
                    <h4>VirusTotal Analysis</h4>
                    {% if results.virustotal and results.virustotal.last_analysis_stats %}
                    <ul>
                        <li><strong>Malicious:</strong> {{ results.virustotal.last_analysis_stats.malicious }}</li>
                        <li><strong>Suspicious:</strong> {{ results.virustotal.last_analysis_stats.suspicious }}</li>
                        <li><strong>Reputation:</strong> {{ results.virustotal.reputation }}</li>
                    </ul>
                    {% else %}
                    <p style="opacity: 0.6;">No data found.</p>
                    {% endif %}
                </div>

                <!-- Shodan -->
                <div class="results-card">
                    <h4>Shodan Device Intelligence</h4>
                    {% if results.shodan and (not results.shodan.error) %}
                    <ul>
                        <li><strong>ISP:</strong> {{ results.shodan.isp }}</li>
                        <li><strong>Open Ports:</strong> {{ results.shodan.ports | join(', ') }}</li>
                        <li><strong>Known CVEs:</strong>
                            {% if results.shodan.vulns %}
                                {{ results.shodan.vulns | join(', ') }}
                            {% else %}
                                None
                            {% endif %}
                        </li>
                    </ul>
                    {% else %}
                    <p style="opacity: 0.6;">No data found.</p>
                    {% endif %}
                </div>

                <!-- OTX -->
                <div class="results-card">
                    <h4>OTX Threat Intelligence</h4>
                    <ul>
                        {% if results.otx.pulse_info %}
                            <li><strong>Threat Reports (Pulses):</strong> {{ results.otx.pulse_info.count }}</li>
                        {% else %}
                            <li><strong>Threat Reports (Pulses):</strong> 0</li>
                        {% endif %}
                    </ul>
                </div>

            {% endif %}
        </div>

    </div>
    {% endif %}
</div>
{% endblock %}
